#! /usr/bin/perl
# A very simple configure script for the acsimsep/src directory
# Configure each of the required subprojects
##  by Paul Hines

use File::Copy;
use Cwd;

# The list of project to configure
my @subprojects = ("ThirdParty");

# variables
my $blaslink = undef;
my $wdir = cwd."/";
my $prefix = $wdir; # defaults to the current working directory


# process the inputs
foreach (@ARGV) {
	$blaslink=$1 if m/--with-blas=\"?(.+)\"?/;
	$prefix=$1   if m/--prefix=\"?(.+)\"?/;
}

# build the configure command
my $command = "./configure ";
$command .= "--prefix=\"$prefix\" " if defined $prefix;
$command .= "--with-blas=\"$blaslink\" " if defined $blaslink;

foreach (@subprojects) {
	# print something
	print "Configuring the $_ directory\n";
	# configure each of the subdirectories
	chdir "$_";
	# now run the configure command
	system("$command")==0 or die;
	# and go back to the original directory
	chdir $wdir;
}

# write the Makefile
print "Writing the makefile for the src/ directory.\n";
open(INFILE, "<Makefile.in") or die;
open(OUTFILE, ">Makefile") or die;
print OUTFILE "\#\# This makefile was auto-generated from Makefile.in\n";
while ($line=<INFILE>) {
	# substitute the prefix line:
	$line =~ s/PREFIX\s*=.*/PREFIX = $prefix/;
	# print the line to the makefile
	print OUTFILE $line;
}

# done
print "Successfully configured src/\n";
exit 0;
