#! /usr/bin/perl
# A very simple configure script for the acsimsep/src/ThirdParty directory
##  by Paul Hines

use File::Copy;
use Cwd;

# variables
my $wdir = cwd;
my $default_blaslink=undef;
my $blaslink=undef;
my $prefix=$wdir; # defaults to the current working directory
my $count=0;
my $SuiteSparse = `ls SuiteSparse*.tar.gz`;

# process the inputs
foreach (@ARGV) {
	$blaslink=$1 if m/--with-blas=\"?(.+)\"?/;
	$prefix=$1   if m/--prefix=\"?(.+)\"?/;
}

# print a quick header
print "Attempting to configure the ThirdParty code.\n";

# check to see that things are downloaded
unless (-d "Coin-Bonmin/") {
	system("./download");
}

# unless ($blaslink) {
# 	print "Enter the link string for your blas library [$default_blaslink] > ";
# 	$blaslink = <STDIN>;
# 	chomp($blaslink);
# 	$blaslink = $default_blaslink unless $blaslink=~/\w/;
# }
#print "Using \"$blaslink\" to link to blas.\n";
print "Using \"$prefix\" as the installation directory.\n";

## if the Coin-Bonmin directory already exists, check to see if the user wants to reconfigure (time consuming)
my $reconfigure="y";
if (-e "Coin-Bonmin/Makefile") {
	print "Do you want to reconfigure Coin-Bonmin? (y or [n]) > ";
	$reconfigure=<STDIN>;
}
if ($reconfigure=~m/y/i) {
	# check to make sure that HSL file exist
	# print "Attempting to configure HSL\n";
	# opendir(DIR,"$prefix/ThirdParty/HSL/") or die "Could not open the $prefix/ThirdParty/HSL/ directory";
	# @files = readdir(DIR);
	# foreach (@files) {
	# 	if (/(.+\.f)/) {
	# 		print "Copying $1 to Coin-Bonmin/ThirdParty/HSL\n";
	# 		$count=$count+1 if copy("HSL/$1","Coin-Bonmin/ThirdParty/HSL/$1");
	# 	}
	# }
	# unless ($count>0) { die "It looks like the HSL files are not installed" };

	# # configure and make HSL
	# chdir "$prefix/ThirdParty/Coin-Bonmin/ThirdParty/HSL" or die "could not enter the HSL directory\n";
	# system("./configure && make && make install")==0 or die "It looks like the HSL files are not installed.  Install the HSL files, and start again.\n";
	#
	# # configure and make ASL
	# chdir "$prefix/ThirdParty/Coin-Bonmin/ThirdParty/ASL";
	# system("./configure && make && make install")==0 or die "It looks like ASL files have not been downloaded yet.\n";
	#
	# # configure and make Lapack
	# chdir "$prefix/ThirdParty/Coin-Bonmin/ThirdParty/Lapack";
	# system("./configure && make && make install")==0 or die "It looks like lapack files have not been downloaded yet.\n";

	# configure the main Coin-Bonmin package
	print "Configuring Coin-Bonmin\n";
	chdir "Coin-Bonmin" or die;
	my $command = "./configure ";
	$command .= "--prefix=\"$prefix\" " if defined $prefix;
	$command .= "--with-blas=\"$blaslink\" " if defined $blaslink;
	print "$command\n";
	system("$command")==0 or die;
	
}
# configure SuiteSparse
unless (-d "SuiteSparse") {
	system("tar xvfz $SuiteSparse");		
}

# write the make file
# add the prefix variable to the Makefile
print "Writing the makefile for the ThirdParty/ directory\n";
open(INFILE, "<Makefile.in") or die;
open(OUTFILE, ">Makefile") or die;
print OUTFILE "\#\# This makefile was auto-generated from Makefile.in\n";
while ($line=<INFILE>) {
	# substitute the prefix line:
	$line =~ s/PREFIX\s*=.*/PREFIX = $prefix/;
	# print the line to the makefile
	print OUTFILE $line;
}

# return to the original directory and exit
chdir "$wdir" or die;
print "Successfully configured ThirdParty/\n";
exit 0;
